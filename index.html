<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniBTC æƒé™ç®¡ç†é¢æ¿ï¼ˆç™½åå•/é»‘åå•ï¼‰</title>
    <!-- Bootstrap æ ·å¼ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Ethers.js -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        /* é€šç”¨æ ·å¼ï¼ˆä¸åŸæœ‰é¢æ¿ä¿æŒä¸€è‡´ï¼‰ */
        body {
            background-color: #f5f7fa;
            padding-bottom: 50px;
        }
        .container {
            max-width: 1200px;
        }
        .header-bar {
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }
        .contract-card {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }
        .contract-card h4 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            font-weight: 600;
            color: #34495e;
        }
        .btn-custom {
            background-color: #3498db;
            color: #fff;
            border: none;
            padding: 8px 20px;
            border-radius: 5px;
            transition: all 0.3s;
        }
        .btn-custom:hover {
            background-color: #2980b9;
            color: #fff;
        }
        .btn-custom:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        .btn-read {
            background-color: #2ecc71;
            color: #fff;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            margin-left: 10px;
            transition: all 0.3s;
        }
        .btn-read:hover {
            background-color: #27ae60;
            color: #fff;
        }
        .btn-unlock {
            font-size: 0.8em;
            color: #999;
            cursor: pointer;
            margin-left: 5px;
        }
        .btn-unlock:hover {
            color: #3498db;
        }
        /* çŠ¶æ€æç¤º */
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 5px;
            display: none;
        }
        .status.loading {
            display: block;
            background-color: #f8f9fa;
            color: #0d6efd;
        }
        .status.success {
            display: block;
            background-color: #d4edda;
            color: #155724;
        }
        .status.error {
            display: block;
            background-color: #f8d7da;
            color: #721c24;
        }
        /* æŠ˜å é¢æ¿ */
        .collapse-btn {
            background: none;
            border: none;
            color: #3498db;
            font-size: 0.9em;
            cursor: pointer;
        }
        .collapse-content {
            margin-top: 15px;
        }
        /* åœ°å€/æ•°å€¼æ ¡éªŒ */
        .is-invalid {
            border-color: #dc3545 !important;
        }
        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.85em;
            margin-top: 5px;
        }
        /* åªè¯»æ ·å¼ */
        .addr-input[readonly], .form-control[readonly] {
            background-color: #f8f9fa;
            cursor: not-allowed;
        }
        /* å¼€å…³æ ·å¼ä¼˜åŒ– */
        .form-switch {
            padding-left: 2.5rem;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <!-- å¤´éƒ¨ï¼šé’±åŒ…è¿æ¥ + åˆçº¦åœ°å€é…ç½® -->
        <div class="header-bar">
            <div class="row align-items-center">
                <div class="col-md-4 mb-3 mb-md-0">
                    <h3>MiniBTC æƒé™ç®¡ç†é¢æ¿</h3>
                </div>
                <div class="col-md-8">
                    <!-- é’±åŒ…è¿æ¥ -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <button id="connectWallet" class="btn-custom w-100">è¿æ¥é’±åŒ…</button>
                            <div id="walletStatus" class="mt-2 text-muted">æœªè¿æ¥é’±åŒ…</div>
                        </div>
                        <div class="col-md-6">
                            <select id="chainSelector" class="form-control">
                                <option value="56">BSC ä¸»ç½‘ (56)</option>
                                <option value="97">BSC æµ‹è¯•ç½‘ (97)</option>
                                <option value="1">ä»¥å¤ªåŠä¸»ç½‘ (1)</option>
                                <option value="5">ä»¥å¤ªåŠæµ‹è¯•ç½‘ Goerli (5)</option>
                            </select>
                        </div>
                    </div>

                    <!-- MiniBTC åˆçº¦åœ°å€é…ç½®ï¼ˆå›ºå®šä¸ºä½ çš„åˆçº¦åœ°å€ï¼‰ -->
                    <div class="row">
                        <div class="col-md-8 mb-2">
                            <label class="form-label">MiniBTC åˆçº¦åœ°å€
                                <span class="btn-unlock" onclick="unlockInput('miniBtcAddr')">ğŸ”“ è§£é”</span>
                            </label>
                            <input type="text" id="miniBtcAddr" class="form-control addr-input" 
                                value="0x0F3BA1d1571511DE2295866E91ea4a6C152A7999" readonly placeholder="0x...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MiniBTC æ ¸å¿ƒæƒé™ç®¡ç† -->
        <div class="contract-card">
            <div class="d-flex justify-content-between align-items-center">
                <h4>æ ¸å¿ƒæƒé™é…ç½®</h4>
                <button class="collapse-btn" onclick="toggleCollapse('corePermissionCollapse')">æ”¶èµ· â–²</button>
            </div>
            <div id="corePermissionCollapse" class="collapse-content">
                <!-- 1. ä¹°å¸ç™½åå•ç®¡ç† -->
                <div class="row mb-4 border-bottom pb-3">
                    <div class="col-12">
                        <h6>1. ä¹°å¸ç™½åå•ç®¡ç†</h6>
                        <div class="row align-items-end">
                            <div class="col-md-5">
                                <input type="text" id="buyWhitelistAddr" class="form-control" placeholder="éœ€è¦é…ç½®çš„åœ°å€">
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="buyWhitelistStatus" checked>
                                    <label class="form-check-label" for="buyWhitelistStatus">åŠ å…¥ç™½åå•ï¼ˆå–æ¶ˆåˆ™ç§»é™¤ï¼‰</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button onclick="callMiniBtcFunction('setBuyWhitelist')" class="btn-custom w-100">æ‰§è¡Œ</button>
                            </div>
                            <div class="col-md-2">
                                <button onclick="readMiniBtcConfig('buyWhitelist')" class="btn-read w-100">è¯»å–çŠ¶æ€</button>
                            </div>
                        </div>
                        <div id="buyWhitelistStatusMsg" class="status"></div>
                    </div>
                </div>

                <!-- 2. å—ä¿¡ä»»åˆçº¦ç®¡ç† -->
                <div class="row mb-4 border-bottom pb-3">
                    <div class="col-12">
                        <h6>2. å—ä¿¡ä»»åˆçº¦ç®¡ç†ï¼ˆè±å…Anti-snipeæ£€æŸ¥ï¼‰</h6>
                        <div class="row align-items-end">
                            <div class="col-md-5">
                                <input type="text" id="trustedContractAddr" class="form-control" placeholder="éœ€è¦é…ç½®çš„åˆçº¦åœ°å€">
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="trustedContractStatus" checked>
                                    <label class="form-check-label" for="trustedContractStatus">è®¾ä¸ºå—ä¿¡ä»»ï¼ˆå–æ¶ˆåˆ™ç§»é™¤ï¼‰</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button onclick="callMiniBtcFunction('setTrustedContract')" class="btn-custom w-100">æ‰§è¡Œ</button>
                            </div>
                            <div class="col-md-2">
                                <button onclick="readMiniBtcConfig('trustedContract')" class="btn-read w-100">è¯»å–çŠ¶æ€</button>
                            </div>
                        </div>
                        <div id="trustedContractStatusMsg" class="status"></div>
                    </div>
                </div>

                <!-- 3. é»‘åå•ç®¡ç† -->
                <div class="row mb-4 border-bottom pb-3">
                    <div class="col-12">
                        <h6>3. é»‘åå•ç®¡ç†ï¼ˆç¦æ­¢äº¤æ˜“/è½¬è´¦ï¼‰</h6>
                        <div class="row align-items-end">
                            <div class="col-md-5">
                                <input type="text" id="blacklistAddr" class="form-control" placeholder="éœ€è¦é…ç½®çš„åœ°å€">
                            </div>
                            <div class="col-md-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="blacklistStatus">
                                    <label class="form-check-label" for="blacklistStatus">åŠ å…¥é»‘åå•ï¼ˆå–æ¶ˆåˆ™ç§»é™¤ï¼‰</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button onclick="callMiniBtcFunction('setBlacklist')" class="btn-custom w-100">æ‰§è¡Œ</button>
                            </div>
                            <div class="col-md-2">
                                <button onclick="readMiniBtcConfig('blacklist')" class="btn-read w-100">è¯»å–çŠ¶æ€</button>
                            </div>
                        </div>
                        <div id="blacklistStatusMsg" class="status"></div>
                    </div>
                </div>

                <!-- 4. ä¹°å¸å¼€å…³ç®¡ç† -->
                <div class="row mb-4 border-bottom pb-3">
                    <div class="col-12">
                        <h6>4. å…¨å±€ä¹°å¸å¼€å…³</h6>
                        <div class="row align-items-end">
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="buyEnabledSwitch">
                                    <label class="form-check-label" for="buyEnabledSwitch">åŸºç¡€ä¹°å¸å¼€å…³ (buyEnabled)</label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="buysAllowedSwitch">
                                    <label class="form-check-label" for="buysAllowedSwitch">å…¨å±€ä¹°å…¥å…è®¸ (buysAllowed)</label>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <button onclick="callMiniBtcFunction('setBuySwitch')" class="btn-custom w-100">ä¿å­˜å¼€å…³</button>
                            </div>
                            <div class="col-md-2">
                                <button onclick="readMiniBtcConfig('buySwitch')" class="btn-read w-100">è¯»å–å½“å‰å¼€å…³</button>
                            </div>
                        </div>
                        <div id="buySwitchStatusMsg" class="status"></div>
                    </div>
                </div>

                <!-- 5. äº¤æ˜“å¼€å…³ï¼ˆå¯ç”¨/ç¦ç”¨Tradingï¼‰ -->
                <div class="row mb-4 border-bottom pb-3">
                    <div class="col-12">
                        <h6>5. äº¤æ˜“æ€»å¼€å…³ï¼ˆå¯ç”¨/ç¦ç”¨Tradingï¼‰</h6>
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <div class="alert alert-warning">
                                    <strong>æ³¨æ„ï¼š</strong>å¯ç”¨äº¤æ˜“åä¼šè®°å½• launchBlockï¼Œå¼€å¯ Anti-snipe ä¿æŠ¤ï¼›ç¦ç”¨äº¤æ˜“éœ€è°¨æ…ï¼
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button onclick="callMiniBtcFunction('enableTrading')" class="btn-custom w-100">å¯ç”¨äº¤æ˜“</button>
                            </div>
                            <div class="col-md-3">
                                <button onclick="callMiniBtcFunction('disableTrading')" class="btn-custom w-100 bg-danger">ç¦ç”¨äº¤æ˜“</button>
                            </div>
                        </div>
                        <div id="tradingSwitchStatusMsg" class="status"></div>
                    </div>
                </div>

                <!-- 6. Anti-snipe å‚æ•°å¿«é€Ÿé…ç½® -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6>6. Anti-snipe å‚æ•°é…ç½®</h6>
                        <div class="row mb-2">
                            <div class="col-md-2">
                                <label class="form-label">é˜²æŠ¢è´­åŒºå—æ•°</label>
                                <input type="number" id="antiSnipeBlocks" class="form-control" value="3" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">å•ç¬”æœ€å¤§ä¹°å…¥</label>
                                <input type="number" id="maxBuyAmount" class="form-control" value="0" min="0" placeholder="0=æ— é™åˆ¶">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">é’±åŒ…æŒå¸ä¸Šé™</label>
                                <input type="number" id="maxWalletAmount" class="form-control" value="0" min="0" placeholder="0=æ— é™åˆ¶">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">å†·å´åŒºå—æ•°</label>
                                <input type="number" id="cooldownBlocks" class="form-control" value="1" min="0">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button onclick="callMiniBtcFunction('setAntiSnipeParams')" class="btn-custom w-100">ä¿å­˜å‚æ•°</button>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">&nbsp;</label>
                                <button onclick="readMiniBtcConfig('antiSnipeParams')" class="btn-read w-100">è¯»å–å‚æ•°</button>
                            </div>
                        </div>
                        <div id="antiSnipeParamsStatusMsg" class="status"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒäº¤äº’è„šæœ¬ -->
    <script>
        // å…¨å±€å˜é‡
        let provider, signer, walletAddress;

        // MiniBTC æ ¸å¿ƒ ABIï¼ˆä»…åŒ…å«æƒé™ç®¡ç†ç›¸å…³å‡½æ•°ï¼‰
        const miniBtcABI = [
            // è¯»å–å‡½æ•°
            "function buyWhitelist(address) view returns (bool)",
            "function trustedContracts(address) view returns (bool)",
            "function blacklist(address) view returns (bool)",
            "function buyEnabled() view returns (bool)",
            "function buysAllowed() view returns (bool)",
            "function tradingEnabled() view returns (bool)",
            "function launchBlock() view returns (uint256)",
            "function antiSnipeBlocks() view returns (uint256)",
            "function maxBuyAmount() view returns (uint256)",
            "function maxWalletAmount() view returns (uint256)",
            "function cooldownBlocks() view returns (uint256)",
            
            // å†™å…¥å‡½æ•°
            "function setBuyWhitelist(address account, bool allowed) external",
            "function setTrustedContract(address account, bool trusted) external",
            "function setBlacklist(address account, bool flagged) external",
            "function setBuyEnabled(bool enabled) external",
            "function setBuysAllowed(bool allowed) external",
            "function enableTrading() external",
            "function disableTrading() external",
            "function setAntiSnipeParams(uint256 antiBlocks, uint256 maxBuy, uint256 maxWallet, uint256 _cooldownBlocks) external"
        ];

        // ========== é’±åŒ…è¿æ¥é€»è¾‘ï¼ˆä¸åŸæœ‰é¢æ¿ä¿æŒä¸€è‡´ï¼‰ ==========
        window.addEventListener('DOMContentLoaded', async () => {
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        initWallet(accounts[0]);
                    }
                } catch (err) {
                    console.log('æ£€æŸ¥é’±åŒ…çŠ¶æ€å¤±è´¥:', err);
                }

                window.ethereum.on('accountsChanged', (accounts) => {
                    if (accounts.length > 0) {
                        initWallet(accounts[0]);
                    } else {
                        resetWalletStatus();
                    }
                });

                window.ethereum.on('chainChanged', (chainId) => {
                    window.location.reload();
                });
            }
        });

        async function initWallet(addr) {
            walletAddress = addr;
            provider = new ethers.providers.Web3Provider(window.ethereum, 'any');
            await provider.send('eth_requestAccounts', []);
            signer = provider.getSigner();
            
            document.getElementById('walletStatus').textContent = `å·²è¿æ¥: ${walletAddress.substring(0, 6)}...${walletAddress.substring(38)}`;
            document.getElementById('walletStatus').style.color = '#198754';
            document.getElementById('connectWallet').textContent = 'åˆ‡æ¢é’±åŒ…';

            // è¿æ¥é’±åŒ…åè‡ªåŠ¨è¯»å–ä¸€æ¬¡æ ¸å¿ƒå¼€å…³çŠ¶æ€
            readMiniBtcConfig('buySwitch');
        }

        function resetWalletStatus() {
            walletAddress = null;
            provider = null;
            signer = null;
            document.getElementById('walletStatus').textContent = 'æœªè¿æ¥é’±åŒ…';
            document.getElementById('walletStatus').style.color = '#6c757d';
            document.getElementById('connectWallet').textContent = 'è¿æ¥é’±åŒ…';
        }

        document.getElementById('connectWallet').addEventListener('click', async () => {
            if (!window.ethereum) {
                alert('è¯·å®‰è£…MetaMaské’±åŒ…ï¼ˆæˆ–å…¶ä»–EVMå…¼å®¹é’±åŒ…ï¼‰ï¼');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ 
                    method: 'eth_requestAccounts'
                });

                if (accounts.length === 0) {
                    throw new Error('æœªæˆæƒä»»ä½•è´¦æˆ·');
                }

                initWallet(accounts[0]);
            } catch (error) {
                document.getElementById('walletStatus').textContent = `è¿æ¥å¤±è´¥: ${error.message}`;
                document.getElementById('walletStatus').style.color = '#dc3545';
                console.error('é’±åŒ…è¿æ¥é”™è¯¯:', error);
            }
        });

        // åˆ‡æ¢é“¾é€»è¾‘
        document.getElementById('chainSelector').addEventListener('change', async (e) => {
            if (!window.ethereum) {
                alert('è¯·å®‰è£…MetaMaské’±åŒ…ï¼');
                return;
            }

            const chainId = e.target.value;
            const hexChainId = ethers.utils.hexValue(parseInt(chainId));

            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: hexChainId }],
                });
            } catch (switchError) {
                if (switchError.code === 4902) {
                    alert(`å½“å‰é’±åŒ…æœªæ·»åŠ è¯¥é“¾ï¼Œè¯·æ‰‹åŠ¨æ·»åŠ é“¾ID ${chainId} åé‡è¯•ï¼`);
                } else {
                    alert(`åˆ‡æ¢é“¾å¤±è´¥: ${switchError.message}`);
                }
            }
        });

        // è§£é”/é”å®šè¾“å…¥æ¡†
        function unlockInput(id) {
            const input = document.getElementById(id);
            if (input.readOnly) {
                input.readOnly = false;
                input.style.backgroundColor = '#fff';
                input.style.cursor = 'text';
                const unlockBtn = input.parentElement.querySelector('.btn-unlock');
                unlockBtn.textContent = 'ğŸ”’ é”å®š';
                unlockBtn.onclick = () => lockInput(id);
            }
        }

        function lockInput(id) {
            const input = document.getElementById(id);
            input.readOnly = true;
            input.style.backgroundColor = '#f8f9fa';
            input.style.cursor = 'not-allowed';
            const unlockBtn = input.parentElement.querySelector('.btn-unlock');
            unlockBtn.textContent = 'ğŸ”“ è§£é”';
            unlockBtn.onclick = () => unlockInput(id);
        }

        // æŠ˜å /å±•å¼€é¢æ¿
        function toggleCollapse(id) {
            const content = document.getElementById(id);
            const btn = content.parentElement.querySelector('.collapse-btn');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                btn.textContent = 'æ”¶èµ· â–²';
            } else {
                content.style.display = 'none';
                btn.textContent = 'å±•å¼€ â–¼';
            }
        }

        // ========== è¯»å–MiniBTCé…ç½®å‡½æ•° ==========
        async function readMiniBtcConfig(configKey) {
            if (!provider) return alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
            const contractAddr = document.getElementById('miniBtcAddr').value;
            if (!ethers.utils.isAddress(contractAddr)) return alert('MiniBTCåˆçº¦åœ°å€æ— æ•ˆï¼');
            
            const contract = new ethers.Contract(contractAddr, miniBtcABI, provider);
            let statusEl;

            try {
                // æ ¹æ®ä¸åŒé…ç½®é¡¹è·å–å¯¹åº”çš„çŠ¶æ€å…ƒç´ 
                switch(configKey) {
                    case 'buyWhitelist':
                        statusEl = document.getElementById('buyWhitelistStatusMsg');
                        const buyWhitelistAddr = document.getElementById('buyWhitelistAddr').value;
                        if (!ethers.utils.isAddress(buyWhitelistAddr)) throw new Error('åœ°å€æ ¼å¼æ— æ•ˆ');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'æ­£åœ¨è¯»å–ç™½åå•çŠ¶æ€...';
                        const isInBuyWhitelist = await contract.buyWhitelist(buyWhitelistAddr);
                        document.getElementById('buyWhitelistStatus').checked = isInBuyWhitelist;
                        statusEl.className = 'status success';
                        statusEl.textContent = `è¯»å–æˆåŠŸï¼šè¯¥åœ°å€${isInBuyWhitelist ? 'åœ¨' : 'ä¸åœ¨'}ä¹°å¸ç™½åå•ä¸­`;
                        break;

                    case 'trustedContract':
                        statusEl = document.getElementById('trustedContractStatusMsg');
                        const trustedAddr = document.getElementById('trustedContractAddr').value;
                        if (!ethers.utils.isAddress(trustedAddr)) throw new Error('åœ°å€æ ¼å¼æ— æ•ˆ');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'æ­£åœ¨è¯»å–å—ä¿¡ä»»åˆçº¦çŠ¶æ€...';
                        const isTrusted = await contract.trustedContracts(trustedAddr);
                        document.getElementById('trustedContractStatus').checked = isTrusted;
                        statusEl.className = 'status success';
                        statusEl.textContent = `è¯»å–æˆåŠŸï¼šè¯¥åœ°å€${isTrusted ? 'æ˜¯' : 'ä¸æ˜¯'}å—ä¿¡ä»»åˆçº¦`;
                        break;

                    case 'blacklist':
                        statusEl = document.getElementById('blacklistStatusMsg');
                        const blacklistAddr = document.getElementById('blacklistAddr').value;
                        if (!ethers.utils.isAddress(blacklistAddr)) throw new Error('åœ°å€æ ¼å¼æ— æ•ˆ');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'æ­£åœ¨è¯»å–é»‘åå•çŠ¶æ€...';
                        const isBlacklisted = await contract.blacklist(blacklistAddr);
                        document.getElementById('blacklistStatus').checked = isBlacklisted;
                        statusEl.className = 'status success';
                        statusEl.textContent = `è¯»å–æˆåŠŸï¼šè¯¥åœ°å€${isBlacklisted ? 'åœ¨' : 'ä¸åœ¨'}é»‘åå•ä¸­`;
                        break;

                    case 'buySwitch':
                        statusEl = document.getElementById('buySwitchStatusMsg');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'æ­£åœ¨è¯»å–ä¹°å¸å¼€å…³çŠ¶æ€...';
                        const buyEnabled = await contract.buyEnabled();
                        const buysAllowed = await contract.buysAllowed();
                        document.getElementById('buyEnabledSwitch').checked = buyEnabled;
                        document.getElementById('buysAllowedSwitch').checked = buysAllowed;
                        statusEl.className = 'status success';
                        statusEl.textContent = `è¯»å–æˆåŠŸï¼šåŸºç¡€ä¹°å¸å¼€å…³=${buyEnabled}ï¼Œå…¨å±€ä¹°å…¥å…è®¸=${buysAllowed}`;
                        break;

                    case 'antiSnipeParams':
                        statusEl = document.getElementById('antiSnipeParamsStatusMsg');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'æ­£åœ¨è¯»å–Anti-snipeå‚æ•°...';
                        const antiBlocks = await contract.antiSnipeBlocks();
                        const maxBuy = await contract.maxBuyAmount();
                        const maxWallet = await contract.maxWalletAmount();
                        const cooldown = await contract.cooldownBlocks();
                        document.getElementById('antiSnipeBlocks').value = antiBlocks.toString();
                        document.getElementById('maxBuyAmount').value = maxBuy.toString();
                        document.getElementById('maxWalletAmount').value = maxWallet.toString();
                        document.getElementById('cooldownBlocks').value = cooldown.toString();
                        statusEl.className = 'status success';
                        statusEl.textContent = 'è¯»å–æˆåŠŸï¼šå·²å¡«å……å½“å‰Anti-snipeå‚æ•°';
                        break;

                    default:
                        throw new Error('æ— æ•ˆçš„é…ç½®é¡¹');
                }
            } catch (error) {
                statusEl = statusEl || document.getElementById('buyWhitelistStatusMsg');
                statusEl.className = 'status error';
                statusEl.textContent = `è¯»å–å¤±è´¥: ${error.message}`;
                console.error('è¯»å–é…ç½®é”™è¯¯:', error);
            }
        }

        // ========== æ‰§è¡ŒMiniBTCå†™å‡½æ•° ==========
        async function callMiniBtcFunction(funcName) {
            if (!provider || !signer) return alert('è¯·å…ˆè¿æ¥é’±åŒ…ï¼');
            const contractAddr = document.getElementById('miniBtcAddr').value;
            if (!ethers.utils.isAddress(contractAddr)) return alert('MiniBTCåˆçº¦åœ°å€æ— æ•ˆï¼');
            
            const contract = new ethers.Contract(contractAddr, miniBtcABI, signer);
            let statusEl, tx;

            try {
                // æ ¹æ®ä¸åŒå‡½æ•°åæ‰§è¡Œå¯¹åº”çš„æ“ä½œ
                switch(funcName) {
                    case 'setBuyWhitelist':
                        statusEl = document.getElementById('buyWhitelistStatusMsg');
                        const buyWhitelistAddr = document.getElementById('buyWhitelistAddr').value;
                        const isAddBuyWhitelist = document.getElementById('buyWhitelistStatus').checked;
                        if (!ethers.utils.isAddress(buyWhitelistAddr)) throw new Error('åœ°å€æ ¼å¼æ— æ•ˆ');
                        
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...';
                        tx = await contract.setBuyWhitelist(buyWhitelistAddr, isAddBuyWhitelist);
                        break;

                    case 'setTrustedContract':
                        statusEl = document.getElementById('trustedContractStatusMsg');
                        const trustedAddr = document.getElementById('trustedContractAddr').value;
                        const isTrusted = document.getElementById('trustedContractStatus').checked;
                        if (!ethers.utils.isAddress(trustedAddr)) throw new Error('åœ°å€æ ¼å¼æ— æ•ˆ');
                        
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...';
                        tx = await contract.setTrustedContract(trustedAddr, isTrusted);
                        break;

                    case 'setBlacklist':
                        statusEl = document.getElementById('blacklistStatusMsg');
                        const blacklistAddr = document.getElementById('blacklistAddr').value;
                        const isAddBlacklist = document.getElementById('blacklistStatus').checked;
                        if (!ethers.utils.isAddress(blacklistAddr)) throw new Error('åœ°å€æ ¼å¼æ— æ•ˆ');
                        
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...';
                        tx = await contract.setBlacklist(blacklistAddr, isAddBlacklist);
                        break;

                    case 'setBuySwitch':
                        statusEl = document.getElementById('buySwitchStatusMsg');
                        const buyEnabled = document.getElementById('buyEnabledSwitch').checked;
                        const buysAllowed = document.getElementById('buysAllowedSwitch').checked;
                        
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'äº¤æ˜“å¤„ç†ä¸­ï¼Œè¯·ç­‰å¾…...';
                        // å…ˆè®¾ç½®buyEnabledï¼Œå†è®¾ç½®buysAllowed
                        await contract.setBuyEnabled(buyEnabled);
                        tx = await contract.setBuysAllowed(buysAllowed);
                        break;

                    case 'enableTrading':
                        statusEl = document.getElementById('tradingSwitchStatusMsg');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'å¯ç”¨äº¤æ˜“ä¸­ï¼Œè¯·ç­‰å¾…...';
                        tx = await contract.enableTrading();
                        break;

                    case 'disableTrading':
                        statusEl = document.getElementById('tradingSwitchStatusMsg');
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'ç¦ç”¨äº¤æ˜“ä¸­ï¼Œè¯·ç­‰å¾…...';
                        tx = await contract.disableTrading();
                        break;

                    case 'setAntiSnipeParams':
                        statusEl = document.getElementById('antiSnipeParamsStatusMsg');
                        const antiBlocks = document.getElementById('antiSnipeBlocks').value;
                        const maxBuy = document.getElementById('maxBuyAmount').value;
                        const maxWallet = document.getElementById('maxWalletAmount').value;
                        const cooldown = document.getElementById('cooldownBlocks').value;
                        
                        if (antiBlocks < 0 || maxBuy < 0 || maxWallet < 0 || cooldown < 0) {
                            throw new Error('å‚æ•°ä¸èƒ½ä¸ºè´Ÿæ•°');
                        }
                        
                        statusEl.className = 'status loading';
                        statusEl.textContent = 'ä¿å­˜å‚æ•°ä¸­ï¼Œè¯·ç­‰å¾…...';
                        tx = await contract.setAntiSnipeParams(
                            ethers.BigNumber.from(antiBlocks),
                            ethers.BigNumber.from(maxBuy),
                            ethers.BigNumber.from(maxWallet),
                            ethers.BigNumber.from(cooldown)
                        );
                        break;

                    default:
                        throw new Error(`ä¸æ”¯æŒçš„å‡½æ•°: ${funcName}`);
                }

                // ç­‰å¾…äº¤æ˜“ä¸Šé“¾
                if (tx) await tx.wait();
                
                // æ›´æ–°çŠ¶æ€æç¤º
                statusEl.className = 'status success';
                statusEl.textContent = `æ“ä½œæˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${tx ? tx.hash.substring(0, 10) + '...' : 'æ“ä½œå®Œæˆ'}`;
                
                // æ“ä½œæˆåŠŸåè‡ªåŠ¨é‡æ–°è¯»å–å¯¹åº”é…ç½®
                const configKeyMap = {
                    'setBuyWhitelist': 'buyWhitelist',
                    'setTrustedContract': 'trustedContract',
                    'setBlacklist': 'blacklist',
                    'setBuySwitch': 'buySwitch',
                    'enableTrading': 'buySwitch',
                    'disableTrading': 'buySwitch',
                    'setAntiSnipeParams': 'antiSnipeParams'
                };
                if (configKeyMap[funcName]) {
                    setTimeout(() => readMiniBtcConfig(configKeyMap[funcName]), 1000);
                }

            } catch (error) {
                statusEl = statusEl || document.getElementById('buyWhitelistStatusMsg');
                let errorMsg = error.message;
                
                // ç®€åŒ–å¸¸è§é”™è¯¯æç¤º
                if (errorMsg.includes('only owner')) {
                    errorMsg = 'æ‰§è¡Œå¤±è´¥ï¼šä»…åˆçº¦æ‹¥æœ‰è€…å¯è°ƒç”¨è¯¥å‡½æ•°';
                } else if (errorMsg.includes('invalid address')) {
                    errorMsg = 'æ‰§è¡Œå¤±è´¥ï¼šæ— æ•ˆçš„åœ°å€æ ¼å¼';
                } else if (errorMsg.length > 100) {
                    errorMsg = errorMsg.substring(0, 100) + '...';
                }
                
                statusEl.className = 'status error';
                statusEl.textContent = `æ‰§è¡Œå¤±è´¥: ${errorMsg}`;
                console.error('æ‰§è¡Œå‡½æ•°é”™è¯¯:', error);
            }
        }

        // é¡µé¢åˆå§‹åŒ–ï¼šé»˜è®¤å±•å¼€æ‰€æœ‰é¢æ¿
        window.onload = function() {
            document.querySelectorAll('.collapse-content').forEach(el => {
                el.style.display = 'block';
            });
            document.querySelectorAll('.collapse-btn').forEach(btn => {
                btn.textContent = 'æ”¶èµ· â–²';
            });
        };
    </script>
</body>
</html>
